<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <div class="container">
        <div class="team-header">
            <h1 th:text="${team.teamName}">팀 이름</h1>
            <span th:text="${team.myRole}">내 역할</span>
        </div>
    </div>

    <div class="team-info">
        <div class="info-row">
            <strong>팀장</strong>
            <span th:text="${team.ownerName}">소유자</span>
        </div>
        <div class="info_row">
            <strong>생성일:</strong>
            <span th:text="${#temporals.format(team.createdAt, 'yyyy-MM-dd HH:mm')}">날짜</span>
        </div>
        <div class="info-row" th:if="${team.description != null}">
            <strong>설명:</strong>
            <p th:text="${team.description}">팀 설명</p>
        </div>
    </div>

    <div>
        <a th:href="@{/teams}">목록으로</a>

        <button th:if="${team.myRole.name() == 'OWNER'}" onclick="showModifyModal()">팀정보 수정</button>

        <button th:if="${team.myRole.name() == 'OWNER'}"
                onclick="deleteTeam()">
            팀 삭제
        </button>
    </div>

    <div class="team-members">
        <div class="section-header">
            <h2>팀 멤버 (<span th:text="${team.members.size()}">0</span>명)</h2>

            <button th:if="${team.myRole.name() == 'OWNER' or team.myRole.name() == 'ADMIN'}" onclick="showInviteModal()">
                멤버 초대
            </button>
        </div>
    </div>

    <!-- 멤버 초대 모달 -->
    <div id="inviteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeInviteModal()">&times;</span>
            <h2>멤버 초대</h2>
            <form id="inviteForm" onsubmit="inviteMember(event)">

                <div class="form-group">
                    <label>아이디</label>
                    <input type="text" id="inviteMemberId" placeholder="초대할 사람의 아이디" required />
                </div>

                <div class="form-group">
                    <label>역할</label>
                    <select id="inviteRole" required>
                        <option value="MEMBER">MEMBER (일반 멤버)</option>
                        <option value="ADMIN" th:if="${team.myRole.name() == 'OWNER'}">ADMIN (관리자)</option>
                        <option value="VIEWER">VIEWER (조회만 가능)</option>
                    </select>
                </div>

                <div>
                    <button type="submit">초대하기</button>
                    <button type="button" onclick="closeInviteModal()">닫기</button>
                </div>

            </form>
        </div>
    </div>

    <!-- 팀 정보 수정하기 모달 -->
    <div id="modifyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModifyModal()">&times;</span>
            <h2>팀 정보 수정</h2>
            <form id="modifyForm" onsubmit="modifyTeam(event)">
                <div class="form-group">
                    <label>팀 이름</label>
                    <input th:value="${team.teamName}" type="text" id="teamName" name="teamName" />
                </div>
                <div class="form-group">
                    <label>팀 정보</label>
                    <textarea th:text="${team.description}" id="description" name="description"></textarea>
                </div>
                <div>
                    <button type="submit">수정하기</button>
                    <button type="button" onclick="closeModifyModal()">닫기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script layout:fragment="script" th:inline="javascript">

    /*<![CDATA[*/
    var teamNo = /*[[${team.teamNo}]]*/ 0;
    const csrfToken = /*[[${_csrf.token}]]*/ null;
    const csrfHeader = /*[[${_csrf.headerName}]]*/ null;
    var message = /*[[${message}]]*/ null;
    var error = /*[[${error}]]*/ null;

    if (message) {
        alert(message);
    }
    if (error) {
        alert("에러: " + error);
    }
    /*]]>*/

    // 모달 열기
    function showInviteModal() {
        document.getElementById('inviteModal').style.display = 'block';
    }

    function showModifyModal() {
        document.getElementById('modifyModal').style.display = 'block';
    }

    // 모달 닫기
    function closeInviteModal() {
        document.getElementById('inviteModal').style.display = 'none';
        document.getElementById('inviteForm').reset();
    }

    function closeModifyModal() {
        document.getElementById('modifyModal').style.display = 'none';
        document.getElementById('modifyForm').reset();
    }

    // 멤버 초대
    function inviteMember(event) {

        event.preventDefault();

        const memberId = document.getElementById('inviteMemberId').value;
        const role = document.getElementById('inviteRole').value;

        fetch(`/teams/${teamNo}/invite`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({ memberId: memberId, role: role })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('멤버 초대가 완료되었습니다.');
                closeInviteModal();
                location.reload();
            } else {
                alert('초대 실패: ' + data.message);
            }
        })
        .catch(error => {
            alert('오류가 발생하였습니다: ' + error);
        });
    }

    function modifyTeam(event) {

        event.preventDefault();

        const teamName = document.getElementById('teamName').value;
        const description = document.getElementById('description').value;

        if (!teamName.trim()) {
            alert('팀 이름은 반드시 입력해야합니다.');
            return false;
        }

        fetch(`/teams/${teamNo}/modify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({ teamName: teamName, description: description })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('팀 정보가 성공적으로 수행되었습니다.');
                closeModifyModal();
                location.reload();
            } else {
                alert('팀 정보 수정 실패: ' + data.message);
            }
        })
        .catch(error => {
            alert('오류가 발생하였습니다.: ' + error);
        });
    }

</script>

</html>