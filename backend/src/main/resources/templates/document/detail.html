<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <h1>문서 상세</h1>

    <div class="document-info">
        <table>
            <tr>
                <th>제목</th>
                <td>
                    <span id="titleText" th:text="${document.title}"></span>
                    <input type="text"
                           id="titleInput"
                           th:value="${document.title}"
                           style="display: none"
                           maxlength="200" />
                </td>
            </tr>
            <tr>
                <th>카테고리</th>
                <td>
                    <span id="categoryText" th:text="${document.categoryDescription}"></span>
                    <select id="categoryInput" style="display: none;">
                        <option th:each="cat : ${categories}"
                                th:value="${cat}"
                                th:text="${cat.description}"
                                th:selected="${cat == document.category}"></option>
                    </select>
                </td>
            </tr>
            <tr>
                <th>파일명</th>
                <td th:text="${document.originalFileName}"></td>
            </tr>
            <tr>
                <th>파일 크기</th>
                <td th:text="${#numbers.formatDecimal(document.fileSize / 1024, 1, 2)} + ' KB'"></td>
            </tr>
            <tr>
                <th>작성자</th>
                <td th:text="${document.uploadUserName}"></td>
            </tr>
            <tr>
                <th>팀</th>
                <td th:text="${document.teamName}"></td>
            </tr>
            <tr>
                <th>상태</th>
                <td>
                    <span th:text="${document.statusDescription}"
                          th:classappend="${document.status.name() == 'COMPLETED' ? 'status-completed' :
                                             (document.status.name() == 'PROCESSING' ? 'status-processing' : 'status-failed')}">
                    </span>
                </td>
            </tr>
            <tr>
                <th>등록일</th>
                <td th:text="${#temporals.format(document.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
            </tr>
            <tr>
                <th>수정일</th>
                <td th:text="${#temporals.format(document.updatedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
            </tr>
        </table>
    </div>

    <div>
        <button type="button" id="editBtn" onclick="toggleEdit()">
            수정
        </button>
        <button type="button" id="saveBtn" onclick="saveDocument()" style="display: none;">
            저장
        </button>
        <button type="button" id="cancelBtn" onclick="cancelEdit()" style="display: none;">
            취소
        </button>
        <button type="button" onclick="deleteDocument()">
            삭제
        </button>
        <a th:href="@{/documents/list(teamNo=${document.teamNo})}">
            목록
        </a>
    </div>

    <!-- AI 요약 결과 -->
    <div th:if="${document.summaryText != null}">
        <h2>AI 요약</h2>
        <div>
            <button type="button"
                    id="resummarizeBtn"
                    onclick="resummarize()"
                    th:disabled="${!document.canResummarize}">
                재요약하기
            </button>
            <span th:text="'(남은 횟수: ' + ${document.remainingResummaryCount} + '회)'"></span>
        </div>

        <div>
            <p th:text="${document.summaryText}"></p>
        </div>

        <div th:if="${document.tags != null && !document.tags.isEmpty()}">
            <strong>태그: </strong>
            <span th:each="tag, iterStat : ${document.tags}">
                <span th:text="${tag}"></span>
                <span th:if="${!iterStat.last}">, </span>
            </span>
        </div>

        <div>
            AI 모델: <span th:text="${document.aiModelVersion}"></span>
            생성일: <span th:text="${#temporals.format(document.summaryCreatedAt, 'yyyy-MM-dd HH:mm')}"></span>
            요약 횟수: <span th:text="${document.summaryCount}"></span>
        </div>

        <!-- 관련 문서 추천 -->
        <div th:if="${relatedDocuments != null && !relatedDocuments.isEmpty()}">
            <h2>관련 문서 추천</h2>
            <ul>
                <li th:each="related : ${relatedDocuments}">
                    <a th:href="@{/documents/{docNo}(docNo=${related.documentNo})}" th:text="${related.title}"></a>
                    <span th:text="'[' + ${related.categoryDescription} + ']'"></span>
                    <span th:text="'(매칭 태그: ' + ${related.matchingTagCount} + '개)'"></span>
                </li>
            </ul>
        </div>
    </div>

    <!-- 요약 진행 중 -->
    <div th:if="${document.summaryText == null && document.status.name() == 'PROCESSING'}">
        <h2>AI 요약</h2>
        <div>
            <p>AI 요약을 생성중입니다. 잠시만 기다려주세요 ...</p>
        </div>
    </div>

    <!-- 요약 실패 -->
    <div th:if="${document.summaryText == null && document.status.name() == 'FAILED'}">
        <h2>AI 요약</h2>
        <div>
            <p>AI 요약 생성에 실패했습니다.</p>
        </div>
    </div>

    <script layout:fragment="script" th:inline="javascript">

        const documentNo = /*[[${document.documentNo}]]*/ 0;
        const teamNo = /*[[${document.teamNo}]]*/ 0;
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        let originalTitle = /*[[${document.title}]]*/ '';
        let originalCategory = /*[[${document.category}]]*/ '';

        // 수정 모드 전환
        function toggleEdit() {
            document.getElementById('titleText').style.display = 'none';
            document.getElementById('titleInput').style.display = 'inline-block';
            document.getElementById('categoryText').style.display = 'none';
            document.getElementById('categoryInput').style.display = 'inline-block';

            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';
        }

        // 수정 취소
        function cancelEdit() {
            document.getElementById('titleInput').value = originalTitle;
            document.getElementById('categoryInput').value = originalCategory;

            document.getElementById('titleText').style.display = 'inline';
            document.getElementById('titleInput').style.display = 'none';
            document.getElementById('categoryText').style.display = 'inline';
            document.getElementById('categoryInput').style.display = 'none';

            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // 문서 수정 저장
        function saveDocument() {
            const title = document.getElementById('titleInput').value.trim();
            const category = document.getElementById('categoryInput').value;

            if (!title) {
                alert('제목을 입력해주세요.');
                return false;
            }

            fetch('/documents/' + documentNo + '/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    title: title,
                    category: category
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('수정되었습니다.');
                    location.reload();
                } else {
                    alert(data.message || '수정에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('수정 중 오류가 발생했습니다.');
            });
        }

        // 문서 삭제
        function deleteDocument() {

            if (!confirm('정말 삭제하시겠습니까?')) {
                return false;
            }

            fetch('/documents/' + documentNo + '/delete', {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('문서가 삭제되었습니다.');
                    location.href = '/documents/list?teamNo=' + teamNo;
                } else {
                    alert(data.message || '삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('삭제 중 오류가 발생했습니다.');
            });
        }

        // 재요약 함수 추가
        function resummarize() {
            if (!confirm('AI 요약을 다시 생성하시겠습니까?')) {
                return;
            }

            const formData = new FormData();
            formData.append('documentNo', documentNo);
            formData.append('_csrf', csrfToken);

            fetch('/documents/resummarize', {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('AI 재요약을 시작했습니다. 잠시 후 새로고침해주세요.');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    alert(data.message || '재요약에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error: ', error);
                alert('재요약 중 오류가 발생했습니다.');
            });
        }
    </script>
</div>
</html>